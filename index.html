<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#006747" />
    <meta
      name="description"
      content="Unofficial Sociology B.A. degree planner for TU Dortmund students"
    />
    <title>Sociology B.A. Planner – TU Dortmund</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/icon-192.png" />

    <!-- PWA -->
    <link rel="manifest" href="/manifest.webmanifest" />

    <style>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
      body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

      /* Preload visual to prevent FOUC */
      #root:empty {
        display: flex; align-items: center; justify-content: center;
        min-height: 100vh; background: #F7F6F3;
        font-family: system-ui, sans-serif; color: #006747; font-size: 16px;
      }
      #root:empty::after { content: "Loading…"; }

      /* Simple install bar */
      #pwa-install-bar {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 12px;
        z-index: 9999;
        display: none;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.96);
        box-shadow: 0 8px 24px rgba(0,0,0,0.14);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      #pwa-install-text {
        font-size: 14px;
        line-height: 1.2;
        color: #1a1a1a;
      }
      #pwa-install-actions { display: flex; gap: 8px; align-items: center; }
      #pwa-install-btn, #pwa-install-dismiss {
        border: 0;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        cursor: pointer;
      }
      #pwa-install-btn { background: #006747; color: white; }
      #pwa-install-dismiss { background: #e9e9e9; color: #1a1a1a; }
    </style>

    <!-- Your built app bundle (keep this exact filename from your dist/assets) -->
    <script type="module" crossorigin src="/assets/index-DSyhGvXR.js"></script>

    <!-- Your SW registration (must remain for installability) -->
    <script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script>
  </head>

  <body>
    <div id="root"></div>

    <!-- In-page install UI (shows only when the browser says install is available) -->
    <div id="pwa-install-bar" role="dialog" aria-live="polite" aria-label="Install app">
      <div id="pwa-install-text">Install this app for quicker access.</div>
      <div id="pwa-install-actions">
        <button id="pwa-install-dismiss" type="button">Not now</button>
        <button id="pwa-install-btn" type="button">Install</button>
      </div>
    </div>

    <script>
      (function () {
        // If already installed, do nothing.
        const isStandalone =
          window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
        const isIOSStandalone = ('standalone' in navigator) && navigator.standalone;
        if (isStandalone || isIOSStandalone) return;

        const bar = document.getElementById('pwa-install-bar');
        const btnInstall = document.getElementById('pwa-install-btn');
        const btnDismiss = document.getElementById('pwa-install-dismiss');

        let deferredPrompt = null;

        // Optional: don’t nag if dismissed recently
        const DISMISS_KEY = 'pwa_install_dismissed_at';
        const dismissedAt = Number(localStorage.getItem(DISMISS_KEY) || '0');
        const now = Date.now();
        const COOLDOWN_MS = 7 * 24 * 60 * 60 * 1000; // 7 days
        const canShowUI = !dismissedAt || (now - dismissedAt > COOLDOWN_MS);

        function showBar() { if (canShowUI) bar.style.display = 'flex'; }
        function hideBar() { bar.style.display = 'none'; }

        window.addEventListener('beforeinstallprompt', (e) => {
          // We prevent default so we can show our own UI reliably.
          // (If you prefer Chrome’s own timing/UI, remove the next line.)
          e.preventDefault();

          deferredPrompt = e;
          showBar();
        });

        btnDismiss.addEventListener('click', () => {
          localStorage.setItem(DISMISS_KEY, String(Date.now()));
          hideBar();
        });

        btnInstall.addEventListener('click', async () => {
          if (!deferredPrompt) return;

          deferredPrompt.prompt();
          try {
            const choice = await deferredPrompt.userChoice;
            // choice.outcome is "accepted" or "dismissed"
            if (choice && choice.outcome === 'dismissed') {
              localStorage.setItem(DISMISS_KEY, String(Date.now()));
            }
          } catch (_) {
            // ignore
          } finally {
            deferredPrompt = null;
            hideBar();
          }
        });

        window.addEventListener('appinstalled', () => {
          hideBar();
        });
      })();
    </script>
  </body>
</html>
